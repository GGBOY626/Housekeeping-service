{"version":3,"file":"index.js","sources":["pages/pay/index.vue","../../../../develop/HBuilderX.4.87.2025121004/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcGF5L2luZGV4LnZ1ZQ"],"sourcesContent":["<!--支付订单-->\r\n<template>\r\n  <view class=\"pageCon appBox verifyBox\">\r\n    <!-- 标题 -->\r\n    <NavBar\r\n      title=\"支付订单\"\r\n      :isShowBack=\"true\"\r\n      :handleToLink=\"handleToLink\"\r\n    ></NavBar>\r\n    <!-- end -->\r\n    <view class=\"main\" v-if=\"netStatus\">\r\n      <view class=\"headBox\">\r\n        <view class=\"time\"\r\n          >支付剩余时间<text>{{ times }}</text></view\r\n        >\r\n        <view class=\"tag\">\r\n          <view>订单总价</view>\r\n          <view>{{ price }}元</view>\r\n        </view>\r\n        <view class=\"tag\" v-if=\"cheapPrice !== 0\">\r\n          <view>优惠金额</view>\r\n          <view class=\"cheap\">-{{ cheapPrice == 0 ? 0 : cheapPrice.toFixed(2) }}元</view>\r\n        </view>\r\n        <view class=\"tag\">\r\n          <view>待付金额</view>\r\n          <view\r\n            ><text class=\"cheap\">{{ (price - cheapPrice).toFixed(2) }}元</text\r\n            ></view\r\n          >\r\n        </view>\r\n      </view>\r\n      <view class=\"payBox\">\r\n        <view class=\"wxImg\">\r\n          <image class=\"\" src=\"../../static/wechat.png\" />\r\n          微信支付\r\n        </view>\r\n        <view class=\"check\">\r\n          <!-- 选择框 -->\r\n          <uni-data-checkbox\r\n            multiple\r\n            :localdata=\"range\"\r\n            v-model=\"radio1\"\r\n            @change=\"payChange(1)\"\r\n          ></uni-data-checkbox>\r\n        </view>\r\n      </view>\r\n      <view class=\"payBox\">\r\n        <view class=\"wxImg\">\r\n          <image class=\"\" src=\"../../static/zfb@2x.png\" />\r\n          支付宝支付\r\n        </view>\r\n        <view class=\"check\">\r\n          <!-- 选择框 -->\r\n          <uni-data-checkbox\r\n            multiple\r\n            :localdata=\"range\"\r\n            v-model=\"radio2\"\r\n            @change=\"payChange(2)\"\r\n          ></uni-data-checkbox>\r\n        </view>\r\n      </view>\r\n      <view class=\"pageFoot\">\r\n        <view>\r\n          还需支付：<text>{{ (price - cheapPrice).toFixed(2)  }}元</text>\r\n        </view>\r\n        <button @click=\"getTradeImg\" class=\"agree-btn btn\">确认支付</button>\r\n      </view>\r\n    </view>\r\n    <uni-popup\r\n      ref=\"popup\"\r\n      :is-mask-click=\"true\"\r\n      mask-background-color=\"rgba(0,0,0,0.6)\"\r\n    >\r\n      <view class=\"img\">\r\n        <image :src=\"qrCodeImg\" mode=\"scaleToFill\" />\r\n      </view>\r\n      <button class=\"agree-btn btn paySuccess\" @click=\"handleClickPayResult\">支付完成</button>\r\n    </uni-popup>\r\n  </view>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref } from 'vue';\r\nimport { onLoad, onShow } from '@dcloudio/uni-app';\r\nimport { useStore } from 'vuex';\r\n// 基本数据\r\n// 接口\r\nimport { payOrder, getOrderPayResult } from '@/pages/api/order.js';\r\nimport {\r\n  formatDuringToTime,\r\n} from '@/utils/index.js';\r\n// ------定义变量------\r\nconst store = useStore(); //存储获取数据\r\nconst users = store.state.user; //获取存储数据\r\nconst rocallTime = ref(''); //倒计时\r\nconst times = ref(null);\r\nconst netStatus = ref(true); //判断有无网\r\nconst radio1 = ref([1]);\r\nconst radio2 = ref([0]);\r\nconst popup = ref(null);\r\nlet capsuleBottom = ref();\r\nconst price = ref(0);\r\nconst id = ref('');\r\nconst qrCodeImg = ref('');\r\nconst isback = ref(false); //是否触发了左上角返回按钮\r\nconst tradingChannel = ref('WECHAT_PAY');\r\nconst historyChanel = ref(''); // 记录上一次的支付方式\r\nconst payNum = ref(0); // 请求次数\r\nconst rocallStatus = ref(); //定时器\r\nconst cheapPrice = ref(0)\r\nconst range = ref([\r\n  {\r\n    text: '',\r\n    value: 1,\r\n  },\r\n]);\r\n// ------定义方法------\r\n//胶囊底部距离头部的距离\r\nonLoad((option) => {\r\n  clearInterval(rocallStatus.value);\r\n  id.value = option.id;\r\n  price.value = Number(option.price);\r\n  cheapPrice.value = Number(option.cheapPrice);\r\n  // getTradeStatusTime();\r\n  uni.getSystemInfo({\r\n    success: (res) => {\r\n      capsuleBottom.value = uni.getMenuButtonBoundingClientRect().bottom + 10;\r\n    },\r\n  });\r\n  // formData.value = JSON.parse(decodeURIComponent(option.item));\r\n});\r\n\r\n// 生成二维码\r\nconst getNative = async () => {\r\n  qrCodeImg.value = '';\r\n  await payOrder(\r\n    {\r\n      tradingChannel: tradingChannel.value,\r\n    },\r\n    id.value\r\n  )\r\n    .then((res) => {\r\n      if (res.data.code === 200) {\r\n        if (res.data.data.payStatus === 4) {\r\n          uni.showToast({\r\n            title: '支付成功',\r\n            icon: 'none',\r\n            duration: 2000,\r\n          });\r\n          setTimeout(() => {\r\n            handleClickPay();\r\n          }, 2000);\r\n        } else {\r\n          popup.value.open();\r\n          qrCodeImg.value = res.data.data.qrCode;\r\n          historyChanel.value = tradingChannel.value;\r\n          payNum.value += 1;\r\n        }\r\n      }\r\n    })\r\n    .catch((err) => {\r\n      console.log(err);\r\n    });\r\n};\r\n\r\n// 点击确认支付获取二维码\r\nconst getTradeImg = async () => {\r\n  getNative();\r\n};\r\n// 支付完成\r\nconst handleClickPayResult = async()=>{\r\n  await getOrderPayResult(id.value).then((res)=>{\r\n    if(res.data.code === 200){\r\n      if(res.data.data.payStatus === 4){\r\n        uni.showToast({\r\n          title: '支付成功',\r\n          icon: 'none',\r\n          duration: 2000,\r\n        });\r\n        setTimeout(() => {\r\n          handleClickPay();\r\n        }, 2000);\r\n      }else{\r\n        uni.showToast({\r\n          title: '支付失败',\r\n          icon: 'none',\r\n          duration: 2000,\r\n        });\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\n// ------定义方法------\r\nonShow((e) => {\r\n  let time = getCurrentPages()[getCurrentPages().length - 1].options.time;\r\n  // 获取页面路径参数\r\n  runTimeBack(time?.replace(/-/g, '/'));\r\n});\r\n// 订单倒计时\r\nconst runTimeBack = (val) => {\r\n  const end = Date.parse(new Date(val));\r\n  const now = Date.parse(new Date());\r\n  const m15 = 15 * 60 * 1000;\r\n  let msec = m15 - (now - end);\r\n  // 将msec转换成时分秒\r\n  const time = formatDuringToTime(msec);\r\n  times.value = time;\r\n  // 清除所有的定时器\r\n  // 倒计时\r\n  rocallTime.value = setInterval(() => {\r\n    if (msec > 0) {\r\n      msec -= 1000;\r\n      times.value = formatDuringToTime(msec);\r\n    } else {\r\n      clearInterval(rocallTime.value);\r\n      handleToOrder();\r\n    }\r\n  }, 1000);\r\n};\r\nconst payChange = (val) => {\r\n  if (val === 1) {\r\n    if (radio1.value.length > 0) {\r\n      radio2.value = [];\r\n      tradingChannel.value = 'WECHAT_PAY';\r\n    }\r\n  } else {\r\n    if (radio2.value.length > 0) {\r\n      radio1.value = [];\r\n      tradingChannel.value = 'ALI_PAY';\r\n    }\r\n  }\r\n};\r\n// 跳转到订单列表页\r\nconst handleToOrder = () => {\r\n  clearInterval(rocallStatus.value);\r\n  store.commit('user/setOrderStatus', '');\r\n  store.commit('user/setBackLike', 'pay');\r\n  uni.navigateTo({\r\n    url: '/subPages/order/index',\r\n  });\r\n};\r\n// 列表页返回列表\r\nconst handleToLink = () => {\r\n  clearInterval(rocallStatus.value);\r\n  isback.value = true; //是否触发了左上角返回按钮\r\n  store.commit('user/setBackLike', 'back');\r\n  uni.navigateBack({\r\n    delta: 1,\r\n  });\r\n};\r\n// 下单成功后跳转到下单成功页面\r\nconst handleClickPay = () => {\r\n  uni.navigateTo({\r\n    url: '/pages/pay/components/paySuccessful',\r\n  });\r\n};\r\n</script>\r\n<style src=\"./index.scss\" lang=\"scss\" scoped></style>\r\n<style lang=\"scss\" scoped>\r\n.img {\r\n  width: 498rpx;\r\n  height: 498rpx;\r\n  border-radius: 24rpx;\r\n  background-color: #fff;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  image {\r\n    width: 460rpx;\r\n    height: 460rpx;\r\n  }\r\n}\r\n.paySuccess{\r\n  margin-top: 40rpx;\r\n}\r\n.cheap{\r\n  color: #F74145;\r\n}\r\n</style>\r\n","import MiniProgramPage from 'D:/class_project/jzo2o/jzo2o-front/jzo2o-consumer/pages/pay/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["useStore","ref","onLoad","uni","payOrder","getOrderPayResult","onShow","formatDuringToTime"],"mappings":"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"}