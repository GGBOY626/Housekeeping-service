{"version":3,"file":"index.js","sources":["pages/city/index.vue","../../../../develop/HBuilderX.4.87.2025121004/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2l0eS9pbmRleC52dWU"],"sourcesContent":["<template>\r\n  <view>\r\n    <NavBar title=\"选择服务地址\" :isShowBack=\"true\"></NavBar>\r\n\r\n    <scroll-view\r\n      class=\"w100\"\r\n      scroll-y=\"true\"\r\n      :scroll-into-view=\"scrollIntoId\"\r\n      :style=\"{ height: scrollHeight }\"\r\n      @touchmove.stop.prevent\r\n    >\r\n      <view v-if=\"disPosition\" id=\"hot\">\r\n        <!-- 定位模块 -->\r\n        <view class=\"position\">\r\n          <view class=\"grey\"> 当前城市 </view>\r\n          <view class=\"position_city\">\r\n            <view class=\"position_city_one\" @tap=\"back_city(position, true)\">\r\n              {{ currentCity ? currentCity.name : '定位失败' }}\r\n            </view>\r\n            <view class=\"WarpWeft\" @click=\"getWarpWeft\">\r\n              <image src=\"../../static/cxdw@2x.png\" mode=\"scaleToFill\" />\r\n              <text>{{ po_tips }}</text>\r\n            </view>\r\n          </view>\r\n        </view>\r\n        <!-- 最近模块 -->\r\n        <!-- 热门 -->\r\n        <view class=\"position\" v-if=\"hotCity.length > 0\">\r\n          <view class=\"hot grey\"> 热门城市 </view>\r\n          <view class=\"position_city position_city_hot\">\r\n            <view\r\n              :class=\"\r\n                activeId === item.cityCode\r\n                  ? 'position_city_tag_active position_city_tag'\r\n                  : 'position_city_tag'\r\n              \"\r\n              v-for=\"(item, index) in hotCity\"\r\n              :key=\"index\"\r\n              @tap=\"activeCity(item)\"\r\n            >\r\n              {{ item.cityName }}\r\n            </view>\r\n          </view>\r\n        </view>\r\n      </view>\r\n      <!-- 城市列表 -->\r\n      <view class=\"position\">\r\n        <view class=\"grey\"> 已开通的城市 </view>\r\n        <view\r\n          v-for=\"(item, index) in list\"\r\n          :id=\"item.id\"\r\n          :key=\"index\"\r\n          class=\"cityList\"\r\n        >\r\n          <!-- <view class=\"letter-header bold\">{{ item.idx }}</view> -->\r\n          <view class=\"contents\">\r\n            <view class=\"city-div\" @click=\"selectCity(item)\">\r\n              <text class=\"city\">{{ item.name }}</text>\r\n            </view>\r\n          </view>\r\n        </view>\r\n      </view>\r\n      <view class=\"placeholder footer\"></view>\r\n    </scroll-view>\r\n\r\n    <!-- 右侧字母 -->\r\n    <view\r\n      class=\"letters\"\r\n      id=\"list\"\r\n      v-show=\"false\"\r\n      @touchstart=\"touchStart\"\r\n      @touchmove.stop.prevent=\"touchMove\"\r\n      @touchend=\"touchEnd\"\r\n    >\r\n      <view class=\"fmin\" v-for=\"item in letter\" :key=\"item.idx\">{{\r\n        item.idx\r\n      }}</view>\r\n    </view>\r\n    <!-- 确定获取定位 -->\r\n    <Popup\r\n      ref=\"operate\"\r\n      @handleSub=\"setWarpWeft\"\r\n      :errorTipText=\"errorTipText\"\r\n      :title=\"title\"\r\n    ></Popup>\r\n    <!-- end -->\r\n    <!-- 选中之后字母 -->\r\n    <view class=\"mask\" v-if=\"touchmove\">\r\n      <view class=\"mask-r bold\">{{ scrollIntoId }}</view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted, watch, getCurrentInstance } from 'vue';\r\nimport { getAddress, getCityList } from '../api/address';\r\nimport Popup from '@/components/Operate/index.vue';\r\nimport { tostTip } from '../../utils';\r\nconst customBar = ref('87px'); //导航栏高度\r\nconst winHeight = ref(0); //屏幕高度\r\nconst itemHeight = ref(0); //每个item的高度\r\nconst winOffsetY = ref(0); //滚动条距离顶部的距离\r\nconst touchmove = ref(false); //是否滑动\r\nconst scrollHeight = ref(''); //滚动高度\r\nconst letter = ref([]); //字母\r\nconst operate = ref(null); //定义取消弹层ref\r\nconst title = ref('开启定位权限'); //弹层标题\r\nconst scrollIntoId = ref(''); //滚动到的id\r\nconst list = ref([]); //城市列表\r\nconst activeId = ref(1); //选中的id\r\nconst disPosition = ref(true); //是否显示定位\r\nconst errorTipText = ref({\r\n  text: '需要您打开地理位置才能显示当前定位信息',\r\n});\r\n// 当前所在城市\r\nconst currentCity = ref({\r\n  cityName: '',\r\n  cityCode: '',\r\n});\r\nconst position = ref();\r\nconst po_tips = ref('重新定位');\r\nconst hotCityList = ref([\r\n  { cityName: '北京', cityCode: '010' },\r\n  { cityName: '上海', cityCode: '021' },\r\n  { cityName: '广州', cityCode: '020' },\r\n  { cityName: '深圳', cityCode: '0755' },\r\n]);\r\nconst hotCity = ref([]);\r\nconst instance = getCurrentInstance(); //获取当前实例\r\n// 获取元素信息，并用于计算，tab栏和navBar距离顶部的距离\r\nconst setList = () => {\r\n  uni\r\n    .createSelectorQuery()\r\n    .in(instance)\r\n    .select('#list')\r\n    .boundingClientRect()\r\n    .exec((ret) => {\r\n      winOffsetY.value = ret[0].top;\r\n      winHeight.value = ret[0].height;\r\n      itemHeight.value = winHeight.value / list.value.length;\r\n    });\r\n};\r\n// touchStart是手指触摸到屏幕触发的事件\r\nconst touchStart = (e) => {\r\n  touchmove.value = true;\r\n  let pageY = e.touches[0].pageY;\r\n  let index = Math.floor((pageY - winOffsetY.value) / itemHeight.value);\r\n  if (list.value[index]) {\r\n    scrollIntoId.value = list.value[index].idx;\r\n  }\r\n};\r\n// touchMove是手指在屏幕上滑动触发的事件\r\nconst touchMove = (e) => {\r\n  let pageY = e.touches[0].pageY;\r\n  let index = Math.floor((pageY - winOffsetY.value) / itemHeight.value);\r\n  if (list.value[index] && list.value[index].idx === scrollIntoId.value) {\r\n    return false;\r\n  }\r\n  if (list.value[index]) {\r\n    scrollIntoId.value = list.value[index].idx;\r\n  }\r\n};\r\n// touchEnd是手指离开屏幕触发的事件\r\nconst touchEnd = () => {\r\n  touchmove.value = false;\r\n};\r\n\r\nconst activeCity = (val) => {\r\n  activeId.value = val.cityCode;\r\n  selectCity(val);\r\n};\r\nonMounted(() => {\r\n  getOpenCityList();\r\n  if (uni.getStorageSync('city')) {\r\n    currentCity.value = uni.getStorageSync('city');\r\n  }\r\n  scrollHeight.value =\r\n    uni.getSystemInfoSync().windowHeight - parseInt(customBar.value) + 'px';\r\n  setList();\r\n});\r\n// 定位\r\nconst getWarpWeft = () => {\r\n  po_tips.value = '定位中...';\r\n  // 1. 获取用户授权信息\r\n  wx.getSetting({\r\n    success(res) {\r\n      // 2. 判断用户是否已经授权地理位置\r\n      if (res.authSetting['scope.userLocation']) {\r\n        // 用户已经授权地理位置，直接调用获取地理位置接口\r\n        // 获取定位\r\n        uni.getLocation({\r\n          type: 'gcj02',\r\n          success: function (res) {\r\n            position.value = res;\r\n            getCity(position.value);\r\n            // 延时500毫秒，保证效果，展现出定位中的过程\r\n            setTimeout(() => {\r\n              po_tips.value = '重新定位';\r\n            }, 500);\r\n          },\r\n          fail: function (res) {\r\n            if (res.errMsg.indexOf('wx.onLocationChange') > -1) {\r\n              tostTip('频繁调用会增加电量损耗,请稍后再试');\r\n            } else {\r\n              tostTip('请开启手机的定位相关功能');\r\n            }\r\n            setTimeout(() => {\r\n              po_tips.value = '定位失败';\r\n            }, 500);\r\n            disPosition.value = true;\r\n          },\r\n        });\r\n      } else {\r\n        po_tips.value = '定位失败';\r\n        operate.value.popup.open();\r\n      }\r\n    },\r\n    fail(res) {\r\n      po_tips.value = '定位失败';\r\n    },\r\n  });\r\n};\r\n// 设置定位权限\r\nconst setWarpWeft = () => {\r\n  // 打开设置页面\r\n  wx.openSetting({\r\n    success: (res) => {\r\n      if (res.authSetting['scope.userLocation']) {\r\n        getWarpWeft();\r\n      } else {\r\n        disPosition.value = true;\r\n      }\r\n    },\r\n    fail: (fail) => {\r\n      disPosition.value = true;\r\n      po_tips.value = '定位失败';\r\n    },\r\n  });\r\n  operate.value.popup.close();\r\n};\r\n\r\n// 根据定位经纬度获取城市\r\nconst getCity = (position) => {\r\n  let params = {\r\n    location: position.longitude + ',' + position.latitude,\r\n  };\r\n  getAddress(params).then((res) => {\r\n    if (res.data.code === 200) {\r\n      currentCity.value = res.data.data;\r\n      AreaConfig(currentCity.value);\r\n    }\r\n  });\r\n};\r\n// 获取区域配置\r\nconst AreaConfig = (val) => {\r\n  const currentCitys = list.value.filter((item) => {\r\n    return item.cityCode == val.cityCode;\r\n  });\r\n  if (currentCitys.length === 0) {\r\n    const cityData = ref(val);\r\n    cityData.value.name = val.province && val.city ? val.city : val.province;\r\n    uni.setStorageSync('city', cityData.value);\r\n    return;\r\n  }\r\n  uni.setStorageSync('city', currentCitys[0]);\r\n  currentCity.value = currentCitys[0];\r\n};\r\n// 获取已开通的城市列表\r\nconst getOpenCityList = () => {\r\n  getCityList().then((res) => {\r\n    if (res.data.code === 200) {\r\n      list.value = res.data.data;\r\n      // 对热门城市进行处理,保留已开通的城市\r\n      hotCity.value = hotCityList.value.filter((item) => {\r\n        return list.value.some((city) => {\r\n          return city.cityCode === item.cityCode;\r\n        });\r\n      });\r\n    } else {\r\n      uni.showToast({\r\n        title: res.data.msg,\r\n        icon: 'none',\r\n      });\r\n    }\r\n  });\r\n};\r\n// 选择城市\r\nconst selectCity = (city) => {\r\n  if (city.name) {\r\n    currentCity.value.cityName = city.name;\r\n  } else {\r\n    currentCity.value.cityName = city.cityName;\r\n  }\r\n  currentCity.value.cityCode = city.cityCode;\r\n  AreaConfig(currentCity.value);\r\n  uni.navigateBack({\r\n    delta: 1,\r\n  });\r\n};\r\nwatch(list, () => {\r\n  setTimeout(() => {\r\n    setList();\r\n  }, 100);\r\n});\r\n</script>\r\n\r\n<style scoped src=\"./index.scss\" lang=\"scss\"></style>\r\n","import MiniProgramPage from 'D:/class_project/jzo2o/jzo2o-front/jzo2o-consumer/pages/city/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","getCurrentInstance","uni","onMounted","wx","res","tostTip","position","getAddress","getCityList","watch"],"mappings":"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"}