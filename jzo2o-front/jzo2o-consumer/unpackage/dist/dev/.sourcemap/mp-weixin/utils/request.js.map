{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["import {\n  baseUrl,\n  notToLoginApiUrl\n} from './env'\n// 参数： url:请求地址  param：请求参数  method：请求方式 callBack：回调函数\nconst requestQueue = [];\nexport function request ({\n  url = '/api',\n  params = {},\n  method = 'GET'\n}) {\n  // uni.getStorage({\n  // \tkey: ''\n  // })\n  // 获取token\n  // 请求队列，保存正在进行的请求\n  const token = uni.getStorageSync('token')\n  let header = {\n    // 'Accept': 'application/json',\n    'Access-Control-Allow-Origin': '*',\n    'Content-Type': 'application/json;charset=UTF-8',\n    'Authorization': token\n  }\n  // 构造请求对象\n  const requestConfig = {\n    url: baseUrl + url,\n    data: params,\n    header: header,\n    method: method\n  };\n  // 判断是否有相同的请求正在进行，如果有则返回正在进行的请求\n  // const existingRequest = requestQueue.find(\n  //   req => JSON.stringify(req.config) === JSON.stringify(requestConfig)\n  // );\n  // if (existingRequest) {\n  //   throw new Warning('请求正在进行中，请勿重复请求！')\n  // }\n\n  // // 创建一个延迟函数，用于设置一定时间后从请求队列中移除请求\n  // const delayRemove = (requestConfig, delay) => {\n  //   setTimeout(() => {\n  //     const index = requestQueue.findIndex(req => JSON.stringify(req.config) === JSON.stringify(requestConfig));\n  //     if (index !== -1) {\n  //       requestQueue.splice(index, 1);\n  //     }\n  //   }, delay);\n  // };\n  const requestRes = new Promise((resolve, reject) => {\n    uni.request({\n      ...requestConfig,\n      success: (res) => {\n        const {\n          data\n        } = res\n        resolve(res)\n        if (data.code == 0 || data.code == 200) {\n          resolve(res.data)\n        } else if (res.data.code === 605) {\n          // 当页面路由不是登录页时，跳转到登录页\n          if (getCurrentPages()[getCurrentPages().length - 1].route !== 'pages/login/index') {\n                setTimeout(() => {\n                  uni.navigateTo({\n                    url: `/pages/login/index?isLogin=1&reason=${res.data.msg}`\n                  });\n                }, 2000)\n          }\n        } else {\n          resolve(res.data)\n          handleError(res, resolve, url)\n        }\n      },\n      fail: (err) => {\n        const error = {\n          data: {\n            msg: err.data\n          }\n        }\n        console.log(err);\n        reject(error)\n      }\n    })\n    // requestQueue.push({ config: requestConfig, promise: requestRes });\n    // delayRemove(requestConfig, 1000); // 设置延迟\n  })\n  const handleError = (error, resolve, url) => {\n    var errorCode = error.statusCode;\n    if (errorCode == 401) {\n      uni.removeStorageSync('token');\n      uni.removeStorageSync('nickName')\n      if (!notToLoginApiUrl.includes(url)) {\n        uni.showToast({\n          title: \"请先登录\",\n          icon: \"none\",\n          duration: 10000,\n          success: () => {\n            setTimeout(() => {\n              uni.navigateTo({\n                url: '/pages/login/index'\n              });\n            }, 2000)\n\n          },\n          fail: () => {\n          }\n        });\n      }\n\n    } else if (errorCode == 500) {\n      if (uni.getStorageSync(\"token\") == \"\") {\n        uni.showToast({\n          title: \"请先登录\",\n          icon: \"none\",\n          duration: 2000,\n          success: () => {\n\n          },\n          fail: () => {\n\n          }\n        });\n      } else {\n        uni.showToast({\n          title: error.data.error.message + \"\",\n          icon: \"none\",\n          duration: 10000\n        });\n      }\n    } else {\n      resolve(error)\n    }\n  }\n  return requestRes\n}\n"],"names":["uni","baseUrl","url","notToLoginApiUrl"],"mappings":";;;AAMO,SAAS,QAAS;AAAA,EACvB,MAAM;AAAA,EACN,SAAS,CAAE;AAAA,EACX,SAAS;AACX,GAAG;AAMD,QAAM,QAAQA,cAAAA,MAAI,eAAe,OAAO;AACxC,MAAI,SAAS;AAAA;AAAA,IAEX,+BAA+B;AAAA,IAC/B,gBAAgB;AAAA,IAChB,iBAAiB;AAAA,EAClB;AAED,QAAM,gBAAgB;AAAA,IACpB,KAAKC,UAAO,UAAG;AAAA,IACf,MAAM;AAAA,IACN;AAAA,IACA;AAAA,EACJ;AAkBE,QAAM,aAAa,IAAI,QAAQ,CAAC,SAAS,WAAW;AAClDD,kBAAAA,MAAI,QAAQ;AAAA,MACV,GAAG;AAAA,MACH,SAAS,CAAC,QAAQ;AAChB,cAAM;AAAA,UACJ;AAAA,QACV,IAAY;AACJ,gBAAQ,GAAG;AACX,YAAI,KAAK,QAAQ,KAAK,KAAK,QAAQ,KAAK;AACtC,kBAAQ,IAAI,IAAI;AAAA,QACjB,WAAU,IAAI,KAAK,SAAS,KAAK;AAEhC,cAAI,gBAAiB,EAAC,gBAAiB,EAAC,SAAS,CAAC,EAAE,UAAU,qBAAqB;AAC7E,uBAAW,MAAM;AACfA,4BAAAA,MAAI,WAAW;AAAA,gBACb,KAAK,uCAAuC,IAAI,KAAK,GAAG;AAAA,cAC5E,CAAmB;AAAA,YACF,GAAE,GAAI;AAAA,UACZ;AAAA,QACX,OAAe;AACL,kBAAQ,IAAI,IAAI;AAChB,sBAAY,KAAK,SAAS,GAAG;AAAA,QAC9B;AAAA,MACF;AAAA,MACD,MAAM,CAAC,QAAQ;AACb,cAAM,QAAQ;AAAA,UACZ,MAAM;AAAA,YACJ,KAAK,IAAI;AAAA,UACV;AAAA,QACF;AACDA,sBAAAA,MAAA,MAAA,OAAA,0BAAY,GAAG;AACf,eAAO,KAAK;AAAA,MACb;AAAA,IACP,CAAK;AAAA,EAGL,CAAG;AACD,QAAM,cAAc,CAAC,OAAO,SAASE,SAAQ;AAC3C,QAAI,YAAY,MAAM;AACtB,QAAI,aAAa,KAAK;AACpBF,0BAAI,kBAAkB,OAAO;AAC7BA,oBAAG,MAAC,kBAAkB,UAAU;AAChC,UAAI,CAACG,UAAgB,iBAAC,SAASD,IAAG,GAAG;AACnCF,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,UACN,UAAU;AAAA,UACV,SAAS,MAAM;AACb,uBAAW,MAAM;AACfA,4BAAAA,MAAI,WAAW;AAAA,gBACb,KAAK;AAAA,cACrB,CAAe;AAAA,YACF,GAAE,GAAI;AAAA,UAER;AAAA,UACD,MAAM,MAAM;AAAA,UACX;AAAA,QACX,CAAS;AAAA,MACF;AAAA,IAEP,WAAe,aAAa,KAAK;AAC3B,UAAIA,oBAAI,eAAe,OAAO,KAAK,IAAI;AACrCA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,UACN,UAAU;AAAA,UACV,SAAS,MAAM;AAAA,UAEd;AAAA,UACD,MAAM,MAAM;AAAA,UAEX;AAAA,QACX,CAAS;AAAA,MACT,OAAa;AACLA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO,MAAM,KAAK,MAAM,UAAU;AAAA,UAClC,MAAM;AAAA,UACN,UAAU;AAAA,QACpB,CAAS;AAAA,MACF;AAAA,IACP,OAAW;AACL,cAAQ,KAAK;AAAA,IACd;AAAA,EACF;AACD,SAAO;AACT;;"}